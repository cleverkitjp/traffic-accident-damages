// ===============================
// 交通事故損害賠償オールインワン電卓
// script.js  Part 1 / 3
// ===============================

// -----------------------
// 定数・フォーマッタ
// -----------------------
const JIBAI_INJURY_CAP = 1200000;   // 傷害 自賠責限度額（簡易モデル）
const JIBAI_DEATH_CAP  = 30000000;  // 死亡 自賠責限度額（簡易モデル）

const yenFormatter = new Intl.NumberFormat("ja-JP", {
  style: "currency",
  currency: "JPY",
  maximumFractionDigits: 0
});

let lastResult = null;

// -----------------------
// ユーティリティ
// -----------------------
function toNumberOrNull(value) {
  if (value === "" || value === null || value === undefined) return null;
  const n = Number(value);
  return Number.isFinite(n) ? n : null;
}

function percentText(val) {
  if (val == null) return "-";
  return `${val.toFixed(1).replace(/\.0$/, "")}%`;
}

// -----------------------
// ライプニッツ係数（3%）
// -----------------------
function leibnizFactor(years) {
  const y = Math.max(0, Math.min(40, years)); // ざっくり40年上限
  if (!y) return 0;
  const r = 0.03;
  return (1 - Math.pow(1 + r, -y)) / r;
}

// -----------------------
// 入力取得
// -----------------------
function collectInputs() {
  const status = document.getElementById("victimStatus").value;

  const inputs = {
    status,
    accidentDate: document.getElementById("accidentDate")?.value || "",
    age: toNumberOrNull(document.getElementById("age")?.value),
    annualIncome: toNumberOrNull(document.getElementById("annualIncome")?.value),

    // 傷害・休業損害
    treatmentDays: toNumberOrNull(document.getElementById("treatmentDays")?.value),
    visitDays: toNumberOrNull(document.getElementById("visitDays")?.value),
    absenceDays: toNumberOrNull(document.getElementById("absenceDays")?.value),
    dailyIncome: toNumberOrNull(document.getElementById("dailyIncome")?.value),

    // 後遺障害
    grade: document.getElementById("grade")?.value || "none",
    lossRate: toNumberOrNull(document.getElementById("lossRate")?.value),
    lossYears: toNumberOrNull(document.getElementById("lossYears")?.value),

    // 死亡
    deathSupportType: document.getElementById("deathSupportType")?.value || "",
    deathLifeRate: toNumberOrNull(document.getElementById("deathLifeRate")?.value),
    deathWorkYears: toNumberOrNull(document.getElementById("deathWorkYears")?.value),
    deathPainPreset: document.getElementById("deathPainPreset")?.value || "",
    deathPainCustom: toNumberOrNull(document.getElementById("deathPainCustom")?.value),
    funeralCost: toNumberOrNull(document.getElementById("funeralCost")?.value),

    // 共通
    otherCosts: toNumberOrNull(document.getElementById("otherCosts")?.value) ?? 0,
    faultPercent: toNumberOrNull(document.getElementById("faultPercent")?.value) ?? 0,
    alreadyPaid: toNumberOrNull(document.getElementById("alreadyPaid")?.value) ?? 0
  };

  return inputs;
}

// -----------------------
// 入力バリデーション
// -----------------------
function validateInputs(inputs) {
  const errors = [];

  if (!inputs.status) {
    errors.push("事故類型を選択してください。");
  }

  if (inputs.age != null && (inputs.age < 0 || inputs.age > 100)) {
    errors.push("年齢は0〜100の範囲で入力してください。");
  }

  if (inputs.annualIncome != null && inputs.annualIncome < 0) {
    errors.push("基礎収入は0以上で入力してください。");
  }

  if (inputs.faultPercent < 0 || inputs.faultPercent > 100) {
    errors.push("過失割合（被害者側）は0〜100の範囲で入力してください。");
  }

  if (inputs.alreadyPaid < 0) {
    errors.push("既払金は0以上で入力してください。");
  }

  if (inputs.status === "after") {
    if (inputs.grade === "none") {
      errors.push("後遺障害事故を選択した場合、後遺障害等級を選択してください。");
    }
  }

  if (inputs.status === "death") {
    if (!inputs.deathSupportType) {
      errors.push("死亡事故の場合、生活費控除方式を選択してください。");
    }
    if (!inputs.deathPainPreset) {
      errors.push("死亡事故の場合、死亡慰謝料モデルを選択してください。");
    }
    if (inputs.deathPainPreset === "custom" && !inputs.deathPainCustom) {
      errors.push("死亡慰謝料を任意額指定とした場合は、金額を入力してください。");
    }
  }

  return errors;
}

function showErrors(errors) {
  if (!errors || !errors.length) return;
  alert(errors.join("\n"));
}

// -----------------------
// 裁判所基準：傷害慰謝料（簡易モデル）
// 入通院期間・通院日数からざっくり算定
// -----------------------
function calcCourtInjuryPain(treatmentDays, visitDays) {
  const t = treatmentDays || 0;
  const v = visitDays || 0;
  if (!t && !v) return 0;

  // ざっくり：通院期間（ヶ月）ベースの赤本イメージ
  const months = t / 30;
  let base = 0;

  if (months <= 1) base = 200000;
  else if (months <= 2) base = 300000;
  else if (months <= 3) base = 530000;
  else if (months <= 4) base = 670000;
  else if (months <= 5) base = 820000;
  else if (months <= 6) base = 950000;
  else if (months <= 8) base = 1160000;
  else if (months <= 10) base = 1350000;
  else base = 1500000;

  // 実通院日数が極端に少ない場合はやや調整
  if (v && t && v < t / 3) {
    base *= 0.7;
  }

  return Math.round(base);
}

// -----------------------
// 自賠責基準：傷害慰謝料（4300円×日数、簡易）
// -----------------------
function calcJibaiInjuryPain(treatmentDays, visitDays) {
  const t = treatmentDays || 0;
  const v = visitDays || 0;
  if (!t && !v) return 0;

  const days = Math.min(t * 2, v * 3, 120);
  return days * 4300;
}

// -----------------------
// 自賠責基準：休業損害
// -----------------------
function calcJibaiLostWages(dailyIncome, absenceDays) {
  const d = dailyIncome || 0;
  const a = absenceDays || 0;
  if (!d || !a) return 0;
  return d * a;
}

// -----------------------
// 裁判所基準：後遺障害慰謝料（赤本イメージ）
// -----------------------
const COURT_AFTER_PAIN_TABLE = {
  "1": 28000000,
  "2": 23000000,
  "3": 19900000,
  "4": 16700000,
  "5": 14000000,
  "6": 11800000,
  "7": 10000000,
  "8": 8300000,
  "9": 6900000,
  "10": 5500000,
  "11": 4200000,
  "12": 2900000,
  "13": 1800000,
  "14": 1200000
};

function calcCourtAfterPain(grade) {
  if (!grade || grade === "none") return 0;
  return COURT_AFTER_PAIN_TABLE[grade] || 0;
}

// -----------------------
// 自賠責基準：後遺障害慰謝料（簡易モデル）
// ※本来は等級ごとの定額だが、ここでは代表値のみ
// -----------------------
const JIBAI_AFTER_PAIN_TABLE = {
  "1": 11000000,
  "2": 9580000,
  "3": 8290000,
  "4": 7120000,
  "5": 5990000,
  "6": 4980000,
  "7": 4090000,
  "8": 3240000,
  "9": 2450000,
  "10": 1900000,
  "11": 1360000,
  "12": 930000,
  "13": 570000,
  "14": 320000
};

function calcJibaiAfterPain(grade) {
  if (!grade || grade === "none") return 0;
  return JIBAI_AFTER_PAIN_TABLE[grade] || 0;
}

// -----------------------
// 後遺障害：労働能力喪失率モデル
// -----------------------
const LOSS_RATE_TABLE = {
  "1": 1.0,
  "2": 1.0,
  "3": 1.0,
  "4": 0.92,
  "5": 0.79,
  "6": 0.67,
  "7": 0.56,
  "8": 0.45,
  "9": 0.35,
  "10": 0.27,
  "11": 0.20,
  "12": 0.14,
  "13": 0.09,
  "14": 0.05
};

function resolveLossRate(inputs) {
  if (inputs.lossRate != null) {
    return Math.max(0, Math.min(100, inputs.lossRate)) / 100;
  }
  if (!inputs.grade || inputs.grade === "none") return 0;
  const r = LOSS_RATE_TABLE[inputs.grade];
  return r != null ? r : 0;
}

// -----------------------
// 後遺障害：喪失期間（年）モデル
// 年齢と等級からざっくり決める
// -----------------------
function resolveLossYears(inputs) {
  if (inputs.lossYears != null && inputs.lossYears > 0) {
    return inputs.lossYears;
  }
  if (!inputs.age || !inputs.grade || inputs.grade === "none") return 0;

  const age = inputs.age;
  let base = 0;

  if (age <= 20) base = 30;
  else if (age <= 30) base = 27;
  else if (age <= 40) base = 25;
  else if (age <= 50) base = 20;
  else if (age <= 60) base = 15;
  else if (age <= 67) base = 10;
  else base = 5;

  const g = Number(inputs.grade);
  if (g >= 12) base = Math.min(base, 10);
  if (g === 14) base = Math.min(base, 5);

  return base;
}

// -----------------------
// 裁判所基準：逸失利益（後遺障害）
// -----------------------
function calcLostEarningsCourt(annualIncome, lossRate, lossYears) {
  const income = annualIncome || 0;
  if (!income || !lossRate || !lossYears) return 0;
  const factor = leibnizFactor(lossYears);
  return Math.round(income * lossRate * factor);
}

// -----------------------
// 死亡：生活費控除率モデル
// -----------------------
function getDeathLifeRate(inputs) {
  if (inputs.deathLifeRate != null && inputs.deathLifeRate >= 0 && inputs.deathLifeRate <= 100) {
    return inputs.deathLifeRate / 100;
  }
  switch (inputs.deathSupportType) {
    case "none":
      return 0.4;  // 被扶養者なし
    case "one":
      return 0.3;  // 扶養1名
    case "twoPlus":
      return 0.25; // 扶養2名以上
    default:
      return 0.3;
  }
}

// -----------------------
// 死亡：死亡慰謝料モデル
// -----------------------
function resolveDeathPain(inputs) {
  if (inputs.deathPainPreset === "custom" && inputs.deathPainCustom) {
    return inputs.deathPainCustom;
  }
  if (inputs.deathPainPreset === "self") {
    return 29000000;  // 本人のみモデル
  }
  if (inputs.deathPainPreset === "dependent") {
    return 35000000;  // 一家の支柱モデル
  }
  return 0;
}

// -----------------------
// 死亡：逸失利益（裁判所基準モデル）
// -----------------------
function calcDeathLostEarnings(annualIncome, lifeRate, workYears) {
  const income = annualIncome || 0;
  if (!income) return 0;
  const y = workYears != null ? workYears : 0;
  if (!y) return 0;

  const factor = leibnizFactor(y);
  const net = income * (1 - lifeRate); // 生活費控除後収入
  return Math.round(net * factor);
}

// -----------------------
// 共通：過失相殺・既払控除
// -----------------------
function applyFault(total, faultPercent) {
  const t = total || 0;
  const p = faultPercent || 0;
  const rate = Math.max(0, Math.min(100, p));
  return Math.round(t * (100 - rate) / 100);
}

function applyPaid(total, alreadyPaid) {
  const t = total || 0;
  const p = alreadyPaid || 0;
  return Math.max(0, t - p);
}

// -----------------------
// 構成比（％）
// -----------------------
function buildRatio(values) {
  const injury = values.injury || 0;
  const after = values.after || 0;
  const lost  = values.lost || 0;
  const other = values.other || 0;
  const sum = injury + after + lost + other;
  if (!sum) {
    return { injury: "-", after: "-", lost: "-", other: "-" };
  }
  return {
    injury: percentText(injury * 100 / sum),
    after:  percentText(after  * 100 / sum),
    lost:   percentText(lost   * 100 / sum),
    other:  percentText(other  * 100 / sum)
  };
}

// ===============================
// script.js  Part 2 / 3
// ===============================

// -----------------------
// 典型モデル適用（必要項目を全部埋める）
// -----------------------
function applyModelPreset(key) {
  const setVal = (id, val) => {
    const el = document.getElementById(id);
    if (!el) return;
    el.value = val;
  };

  // 一旦リセット気味にクリア
  setVal("treatmentDays", "");
  setVal("visitDays", "");
  setVal("absenceDays", "");
  setVal("dailyIncome", "");
  setVal("grade", "none");
  setVal("lossRate", "");
  setVal("lossYears", "");
  setVal("deathSupportType", "");
  setVal("deathLifeRate", "");
  setVal("deathWorkYears", "");
  setVal("deathPainPreset", "");
  setVal("deathPainCustom", "");
  setVal("funeralCost", "");
  setVal("otherCosts", 0);
  setVal("faultPercent", 0);
  setVal("alreadyPaid", 0);

  switch (key) {
    // 後遺14級・30代・年収400万
    case "after_14_30":
      setVal("victimStatus", "after");
      setVal("age", 30);
      setVal("annualIncome", 4000000);
      setVal("grade", "14");
      setVal("treatmentDays", 180);
      setVal("visitDays", 40);
      setVal("absenceDays", 30);
      setVal("dailyIncome", 12000);
      break;

    // 後遺12級・40代・年収500万
    case "after_12_40":
      setVal("victimStatus", "after");
      setVal("age", 40);
      setVal("annualIncome", 5000000);
      setVal("grade", "12");
      setVal("treatmentDays", 240);
      setVal("visitDays", 60);
      setVal("absenceDays", 45);
      setVal("dailyIncome", 18000);
      break;

    // 後遺9級・30代・年収600万
    case "after_9_30":
      setVal("victimStatus", "after");
      setVal("age", 30);
      setVal("annualIncome", 6000000);
      setVal("grade", "9");
      setVal("treatmentDays", 300);
      setVal("visitDays", 80);
      setVal("absenceDays", 60);
      setVal("dailyIncome", 20000);
      break;

    // 後遺12級・30代・年収450万
    case "after_12_30":
      setVal("victimStatus", "after");
      setVal("age", 30);
      setVal("annualIncome", 4500000);
      setVal("grade", "12");
      setVal("treatmentDays", 210);
      setVal("visitDays", 50);
      setVal("absenceDays", 40);
      setVal("dailyIncome", 15000);
      break;

    // 死亡・40代一家の支柱
    case "death_40_dep":
      setVal("victimStatus", "death");
      setVal("age", 40);
      setVal("annualIncome", 5000000);
      setVal("deathSupportType", "twoPlus");
      setVal("deathLifeRate", "");
      setVal("deathWorkYears", "");
      setVal("deathPainPreset", "dependent");
      setVal("funeralCost", 1200000);
      break;

    // 死亡・75歳・扶養なし
    case "death_75_single":
      setVal("victimStatus", "death");
      setVal("age", 75);
      setVal("annualIncome", 3000000);
      setVal("deathSupportType", "none");
      setVal("deathLifeRate", "");
      setVal("deathWorkYears", "");
      setVal("deathPainPreset", "self");
      setVal("funeralCost", 1000000);
      break;

    default:
      return;
  }

  updateInputVisibility();
}

// -----------------------
// 裁判所基準構造グラフ
// -----------------------
function updateCourtChart(court) {
  const section = document.getElementById("chartSection");
  const canvas = document.getElementById("courtChart");
  const legend = document.getElementById("chartLegend");
  const note = document.getElementById("chartNote");
  if (!canvas || !legend || !section) return;

  const injury = court.injuryPain || 0;
  const after = court.afterPain || 0;
  const lost = court.lostEarnings || 0;
  const other = (court.lostWages || 0) + (court.otherCosts || 0);
  const total = injury + after + lost + other;

  if (!total) {
    section.classList.add("hidden");
    legend.innerHTML = "";
    if (note) note.textContent = "裁判所基準の総損害額が0円のため表示しません。";
    return;
  }

  section.classList.remove("hidden");
  const ctx = canvas.getContext("2d");
  const w = canvas.width, h = canvas.height;
  ctx.clearRect(0, 0, w, h);

  const cx = w / 2, cy = h / 2, r = Math.min(w, h) / 2 - 10;

  const parts = [
    { label: "傷害慰謝料", value: injury, color: "#60a5fa" },
    { label: "後遺/死亡慰謝料", value: after, color: "#f97373" },
    { label: "逸失利益", value: lost, color: "#22c55e" },
    { label: "その他", value: other, color: "#facc15" }
  ].filter(p => p.value > 0);

  let start = -Math.PI / 2;

  parts.forEach(p => {
    const angle = (p.value / total) * Math.PI * 2;
    ctx.beginPath();
    ctx.moveTo(cx, cy);
    ctx.arc(cx, cy, r, start, start + angle);
    ctx.closePath();
    ctx.fillStyle = p.color;
    ctx.fill();
    start += angle;
  });

  legend.innerHTML = "";
  parts.forEach(p => {
    const pct = (p.value / total * 100).toFixed(1).replace(/\.0$/, "") + "%";
    const item = document.createElement("div");
    item.className = "chart-legend-item";

    const box = document.createElement("span");
    box.className = "chart-legend-color";
    box.style.backgroundColor = p.color;

    const label = document.createElement("span");
    label.textContent = `${p.label}：${yenFormatter.format(p.value)}（${pct}）`;

    item.appendChild(box);
    item.appendChild(label);
    legend.appendChild(item);
  });

  if (note) {
    note.textContent =
      `総損害額 ${yenFormatter.format(total)} の構成比を表示しています。`;
  }
}

// -----------------------
// 結果描画
// -----------------------
function renderResult(result) {
  const court = result.court;
  const jibai = result.jibai;

  const statusLabelMap = {
    injury: "傷害（入通院）",
    after: "後遺障害",
    death: "死亡事故"
  };
  const statusLabel = statusLabelMap[result.meta.status] || "";

  const caseSummaryEl = document.getElementById("caseSummary");
  if (caseSummaryEl) {
    const ageText = result.meta.age ? `${result.meta.age}歳` : "";
    const incomeText = result.meta.annualIncome
      ? `年収 ${yenFormatter.format(result.meta.annualIncome)}`
      : "";
    caseSummaryEl.textContent = [
      statusLabel,
      ageText,
      incomeText
    ].filter(Boolean).join(" ／ ");
  }

  // サマリー
  const courtNet = document.getElementById("courtNetAmount");
  const courtHint = document.getElementById("courtHint");
  if (courtNet) courtNet.textContent = yenFormatter.format(court.afterPaid || 0);
  if (courtHint) {
    courtHint.textContent =
      `① 総損害額 ${yenFormatter.format(court.total || 0)} → ` +
      `② 過失相殺後 ${yenFormatter.format(court.afterFault || 0)} → ` +
      `③ 既払控除後（受取想定） ${yenFormatter.format(court.afterPaid || 0)}`;
  }

  const jibaiNet = document.getElementById("jibaiNetAmount");
  const jibaiHint = document.getElementById("jibaiHint");
  if (jibaiNet) jibaiNet.textContent = yenFormatter.format(jibai.afterPaid || 0);
  if (jibaiHint) {
    let capText = "";
    if (jibai.cap) {
      capText = `（限度額 ${yenFormatter.format(jibai.cap)} を上限とするモデル）`;
    }
    jibaiHint.textContent =
      `① 総損害額 ${yenFormatter.format(jibai.total || 0)} → ` +
      `② 過失相殺後 ${yenFormatter.format(jibai.afterFault || 0)} → ` +
      `③ 既払控除後（受取想定） ${yenFormatter.format(jibai.afterPaid || 0)} ${capText}`;
  }

  // 明細（裁判所基準）
  const setText = (id, value) => {
    const el = document.getElementById(id);
    if (el) el.textContent = value;
  };

  setText("courtInjuryPain", yenFormatter.format(court.injuryPain || 0));
  setText("courtAfterPain", yenFormatter.format(court.afterPain || 0));
  setText("courtLostEarnings", yenFormatter.format(court.lostEarnings || 0));
  setText("courtLostWages", yenFormatter.format(court.lostWages || 0));
  setText("courtOtherCosts", yenFormatter.format(court.otherCosts || 0));
  setText("courtTotal", yenFormatter.format(court.total || 0));
  setText("courtAfterFault", yenFormatter.format(court.afterFault || 0));
  setText("courtAfterPaid", yenFormatter.format(court.afterPaid || 0));

  // 構成比
  const r = court.ratios || {
    injury: "-",
    after: "-",
    lost: "-",
    other: "-"
  };
  setText("courtRatioInjury", r.injury);
  setText("courtRatioAfter", r.after);
  setText("courtRatioLostEarnings", r.lost);
  setText("courtRatioOther", r.other);

  // 自賠責明細
  setText("jibaiInjuryPain", yenFormatter.format(jibai.injuryPain || 0));
  setText("jibaiAfterPain", yenFormatter.format(jibai.afterPain || 0));
  setText("jibaiLostWages", yenFormatter.format(jibai.lostWages || 0));
  setText("jibaiOtherCosts", yenFormatter.format(jibai.otherCosts || 0));
  setText("jibaiTotal", yenFormatter.format(jibai.total || 0));
  setText("jibaiAfterFault", yenFormatter.format(jibai.afterFault || 0));
  setText("jibaiAfterPaid", yenFormatter.format(jibai.afterPaid || 0));

  const capInfo = document.getElementById("jibaiCapInfo");
  if (capInfo) {
    if (jibai.cap) {
      capInfo.textContent = `自賠責限度額：${yenFormatter.format(jibai.cap)} を上限とするモデルです。`;
    } else {
      capInfo.textContent = "";
    }
  }

  // セクション表示
  const resultSection = document.getElementById("resultSection");
  const detailSection = document.getElementById("detailResults");
  if (resultSection) resultSection.classList.remove("hidden");
  if (detailSection) detailSection.classList.remove("hidden");

  // グラフ更新
  updateCourtChart(court);
}

// -----------------------
// メイン計算
// -----------------------
function calculateAll() {
  const inputs = collectInputs();
  const errors = validateInputs(inputs);
  if (errors.length > 0) {
    showErrors(errors);
    const interp = document.getElementById("interpretationMain");
    if (interp) interp.textContent = "";
    return;
  }

  // 死亡：就労可能年数を年齢からモデル算定（必要なら）
  if (inputs.status === "death" && (!inputs.deathWorkYears || inputs.deathWorkYears <= 0)) {
    if (inputs.age > 0 && inputs.age < 80) {
      inputs.deathWorkYears = Math.max(0, 67 - inputs.age);
    }
  }

  let courtInjury = 0,
      courtAfter = 0,
      courtLost = 0,
      courtLostWages = 0,
      courtOther = inputs.otherCosts || 0;

  let deathLifeRateUsed = null;

  if (inputs.status === "injury" || inputs.status === "after") {
    courtInjury = calcCourtInjuryPain(inputs.treatmentDays, inputs.visitDays);

    if (inputs.status === "after") {
      courtAfter = calcCourtAfterPain(inputs.grade);
      const lossRate = resolveLossRate(inputs);
      const lossYears = resolveLossYears(inputs);
      courtLost = calcLostEarningsCourt(inputs.annualIncome, lossRate, lossYears);
    }

    if (inputs.absenceDays && inputs.dailyIncome) {
      courtLostWages = inputs.dailyIncome * inputs.absenceDays;
    }
  } else if (inputs.status === "death") {
    const lifeRate = getDeathLifeRate(inputs);
    deathLifeRateUsed = lifeRate;
    courtAfter = resolveDeathPain(inputs);
    courtLost = calcDeathLostEarnings(inputs.annualIncome, lifeRate, inputs.deathWorkYears);
    courtOther += inputs.funeralCost || 0;
  }

  const courtTotal = courtInjury + courtAfter + courtLost + courtLostWages + courtOther;
  const courtAfterFault = applyFault(courtTotal, inputs.faultPercent);
  const courtAfterPaid = applyPaid(courtAfterFault, inputs.alreadyPaid);
  const courtRatios = buildRatio({
    injury: courtInjury,
    after: courtAfter,
    lost: courtLost,
    other: courtLostWages + courtOther
  });

  // 自賠責側
  let jibaiInjury = 0,
      jibaiAfter = 0,
      jibaiLostWages = 0,
      jibaiOther = inputs.otherCosts || 0,
      jibaiCap = null;

  if (inputs.status === "injury" || inputs.status === "after") {
    jibaiInjury = calcJibaiInjuryPain(inputs.treatmentDays, inputs.visitDays);
    jibaiLostWages = calcJibaiLostWages(inputs.dailyIncome, inputs.absenceDays);
    if (inputs.status === "after") {
      jibaiAfter = calcJibaiAfterPain(inputs.grade);
    }
    jibaiCap = JIBAI_INJURY_CAP;
  } else if (inputs.status === "death") {
    // 死亡：ここでは限度額のみをモデルとして表示
    jibaiCap = JIBAI_DEATH_CAP;
    jibaiInjury = 0;
    jibaiAfter = jibaiCap;
  }

  const jibaiTotal = jibaiInjury + jibaiAfter + jibaiLostWages + jibaiOther;
  const jibaiAfterFault = applyFault(jibaiTotal, inputs.faultPercent);
  const jibaiAfterPaid = applyPaid(jibaiAfterFault, inputs.alreadyPaid);

  const result = {
    court: {
      injuryPain: courtInjury,
      afterPain: courtAfter,
      lostEarnings: courtLost,
      lostWages: courtLostWages,
      otherCosts: courtOther,
      total: courtTotal,
      afterFault: courtAfterFault,
      afterPaid: courtAfterPaid,
      ratios: courtRatios
    },
    jibai: {
      injuryPain: jibaiInjury,
      afterPain: jibaiAfter,
      lostWages: jibaiLostWages,
      otherCosts: jibaiOther,
      total: jibaiTotal,
      afterFault: jibaiAfterFault,
      afterPaid: jibaiAfterPaid,
      cap: jibaiCap
    },
    meta: {
      status: inputs.status,
      age: inputs.age,
      annualIncome: inputs.annualIncome,
      treatmentDays: inputs.treatmentDays,
      visitDays: inputs.visitDays,
      absenceDays: inputs.absenceDays,
      grade: inputs.grade,
      deathSupportType: inputs.deathSupportType,
      deathWorkYears: inputs.deathWorkYears,
      deathLifeRate: deathLifeRateUsed
    }
  };

  lastResult = { inputs, result };
  renderResult(result);
  updateInterpretationFromLastResult();

  const target = document.getElementById("resultSection");
  if (target) {
    setTimeout(() => {
      const rect = target.getBoundingClientRect();
      const y = rect.top + window.pageYOffset - 8;
      window.scrollTo({ top: y, behavior: "smooth" });
    }, 200);
  }
}

// -----------------------
// 事故類型で入力UI切替
// -----------------------
function updateInputVisibility() {
  const v = document.getElementById("victimStatus").value;
  const inj = document.getElementById("injuryInputs");
  const aft = document.getElementById("afterInputs");
  const dth = document.getElementById("deathInputs");

  if (!inj || !aft || !dth) return;

  inj.classList.add("hidden");
  aft.classList.add("hidden");
  dth.classList.add("hidden");

  if (v === "injury") inj.classList.remove("hidden");
  if (v === "after") {
    inj.classList.remove("hidden");
    aft.classList.remove("hidden");
  }
  if (v === "death") dth.classList.remove("hidden");
}

// ===============================
// script.js  Part 3 / 3
// ===============================

// -----------------------
// 結果の簡易解説コメント
// -----------------------
function updateInterpretationFromLastResult() {
  const el = document.getElementById("interpretationMain");
  if (!el) return;

  if (!lastResult) {
    el.textContent = "";
    return;
  }

  const { inputs, result } = lastResult;
  const court = result.court || {};
  const jibai = result.jibai || {};

  const statusLabelMap = {
    injury: "傷害（入通院）",
    after: "後遺障害",
    death: "死亡事故"
  };
  const statusLabel = statusLabelMap[inputs.status] || "";

  const parts = [];

  if (statusLabel) {
    parts.push(`${statusLabel}についての簡易モデル計算結果です。`);
  }

  if (inputs.status === "after") {
    if (inputs.grade && inputs.grade !== "none") {
      parts.push(`後遺障害${inputs.grade}級について、赤本等で示される典型的な慰謝料水準と、基礎収入・年齢に応じた逸失利益モデルを用いて裁判所基準を概算しています。`);
    } else {
      parts.push("後遺障害の等級が未指定のため、慰謝料・逸失利益のモデルは簡略化されています。");
    }
  } else if (inputs.status === "death") {
    parts.push("死亡事故について、年収と扶養状況から就労可能年数と生活費控除率を仮定し、死亡慰謝料モデルと逸失利益を合算した裁判所基準モデルです。");
  } else if (inputs.status === "injury") {
    parts.push("入通院慰謝料と休業損害を中心に、治療期間・通院日数から裁判所基準モデルを簡易算定しています。");
  }

  if (court.total && jibai.total) {
    if (jibai.total > 0) {
      const ratio = court.total / jibai.total;
      if (ratio >= 1.5 && ratio <= 5) {
        parts.push(`裁判所基準の総損害額は、自賠責基準の約${ratio.toFixed(1)}倍となっています。慰謝料水準や逸失利益の扱いの違いによる差です。`);
      } else if (ratio > 5) {
        parts.push("裁判所基準の総損害額は、自賠責基準と比べてかなり高めに算定されています。自賠責は最低限の補償水準であるため、このような差が生じます。");
      } else if (ratio < 1) {
        parts.push("このケースでは、自賠責基準の方が相対的に大きな金額となっています。限度額や算定方式の違いによるものです。");
      }
    } else {
      parts.push("自賠責基準側の金額は、このモデルでは0に近い値となっています（限度額や対象項目の違いによるものです）。");
    }
  }

  parts.push("実際の解決額は、赤本の具体的記載や個別事情により増減しうるため、あくまで目安としてご利用ください。");

  el.textContent = parts.join(" ");
}

// -----------------------
// 損害明細コピー機能
// -----------------------
function buildSummaryTextFromLastResult() {
  if (!lastResult) return "";

  const { inputs, result } = lastResult;
  const court = result.court;
  const jibai = result.jibai;

  const statusLabelMap = {
    injury: "傷害（入通院）",
    after: "後遺障害",
    death: "死亡事故"
  };
  const statusLabel = statusLabelMap[inputs.status] || "";

  const supportMap = {
    none: "被扶養者なし",
    one: "扶養1名",
    twoPlus: "扶養2名以上"
  };

  const lines = [];
  lines.push("【交通事故損害概算（参考値・モデル計算）】");
  if (statusLabel) lines.push(`事故類型：${statusLabel}`);
  if (inputs.age) lines.push(`年齢：${inputs.age}歳`);
  if (inputs.annualIncome) {
    lines.push(`基礎収入：${yenFormatter.format(inputs.annualIncome)}／年`);
  }
  if (inputs.accidentDate) {
    lines.push(`事故日：${inputs.accidentDate}`);
  }
  if (inputs.faultPercent || inputs.faultPercent === 0) {
    lines.push(`過失割合（被害者側）：${inputs.faultPercent}%`);
  }
  if (inputs.alreadyPaid) {
    lines.push(`既払金：${yenFormatter.format(inputs.alreadyPaid)}`);
  }

  if (inputs.status === "injury" || inputs.status === "after") {
    if (inputs.treatmentDays || inputs.visitDays || inputs.absenceDays) {
      const t = inputs.treatmentDays ? `${inputs.treatmentDays}日` : "-";
      const v = inputs.visitDays ? `${inputs.visitDays}日` : "-";
      const a = inputs.absenceDays ? `${inputs.absenceDays}日` : "-";
      lines.push(`治療期間：${t}／実通院日数：${v}／休業日数：${a}`);
    }
    if (inputs.status === "after" && inputs.grade && inputs.grade !== "none") {
      lines.push(`後遺障害等級：${inputs.grade}級（慰謝料モデル＋逸失利益モデル）`);
    }
  }

  if (inputs.status === "death") {
    if (inputs.deathSupportType) {
      lines.push(`扶養状況：${supportMap[inputs.deathSupportType] || ""}`);
    }
    if (inputs.deathWorkYears) {
      lines.push(`就労可能年数（モデル）：約${inputs.deathWorkYears}年（67歳までを目安）`);
    }
    const lifeRate = result.meta && result.meta.deathLifeRate;
    if (lifeRate != null) {
      const pct = (lifeRate * 100).toFixed(1).replace(/\.0$/, "");
      lines.push(`生活費控除率（モデル）：約${pct}%`);
    }
    if (inputs.funeralCost) {
      lines.push(`葬儀費：${yenFormatter.format(inputs.funeralCost)}`);
    }
  }

  lines.push("");
  lines.push("＜裁判所基準モデル＞");
  lines.push(`傷害慰謝料：${yenFormatter.format(court.injuryPain)}`);
  lines.push(`後遺障害／死亡慰謝料：${yenFormatter.format(court.afterPain)}`);
  lines.push(`逸失利益：${yenFormatter.format(court.lostEarnings)}`);
  lines.push(`休業損害：${yenFormatter.format(court.lostWages)}`);
  lines.push(`その他費用：${yenFormatter.format(court.otherCosts)}`);
  lines.push(`総損害額：${yenFormatter.format(court.total)}`);
  lines.push(`過失相殺後：${yenFormatter.format(court.afterFault)}`);
  lines.push(`既払控除後（受取想定）：${yenFormatter.format(court.afterPaid)}`);

  lines.push("");
  lines.push("＜自賠責基準モデル＞");
  lines.push(`傷害慰謝料：${yenFormatter.format(jibai.injuryPain)}`);
  lines.push(`後遺障害慰謝料：${yenFormatter.format(jibai.afterPain)}`);
  lines.push(`休業損害：${yenFormatter.format(jibai.lostWages)}`);
  lines.push(`その他費用：${yenFormatter.format(jibai.otherCosts)}`);
  lines.push(`総損害額：${yenFormatter.format(jibai.total)}`);
  if (jibai.cap) {
    lines.push(`自賠責限度額：${yenFormatter.format(jibai.cap)}`);
  }
  lines.push(`過失相殺後：${yenFormatter.format(jibai.afterFault)}`);
  lines.push(`既払控除後（受取想定）：${yenFormatter.format(jibai.afterPaid)}`);

  lines.push("");
  lines.push("※本明細は公開されている目安額・モデル算式に基づく概算値であり、実際の解決額を保証するものではありません。");

  return lines.join("\n");
}

function copySummaryToClipboard() {
  if (!lastResult) {
    alert("先に「損害額を計算する」を実行してください。");
    return;
  }

  const text = buildSummaryTextFromLastResult();
  if (!text) {
    alert("コピー可能な明細がありません。");
    return;
  }

  let success = false;
  try {
    const textarea = document.createElement("textarea");
    textarea.value = text;
    textarea.style.position = "fixed";
    textarea.style.opacity = "0";
    document.body.appendChild(textarea);
    textarea.focus();
    textarea.select();
    success = document.execCommand("copy");
    document.body.removeChild(textarea);
  } catch (e) {
    console.error("copy execCommand error:", e);
    success = false;
  }

  const statusEl = document.getElementById("copyStatus");

  if (success) {
    if (statusEl) {
      statusEl.textContent = "損害明細をクリップボードにコピーしました。";
      setTimeout(() => {
        statusEl.textContent = "";
      }, 4000);
    } else {
      alert("損害明細をコピーしました。");
    }
  } else {
    window.prompt("コピーに失敗しました。下記テキストを選択してコピーしてください。", text);
    if (statusEl) {
      statusEl.textContent = "損害明細を表示しました（長押しでコピーできます）。";
      setTimeout(() => {
        statusEl.textContent = "";
      }, 4000);
    }
  }
}

// -----------------------
// 初期化
// -----------------------
document.addEventListener("DOMContentLoaded", () => {
  updateInputVisibility();

  const statusSelect = document.getElementById("victimStatus");
  if (statusSelect) {
    statusSelect.addEventListener("change", updateInputVisibility);
  }

  const calcBtn = document.getElementById("calcButton");
  if (calcBtn) {
    calcBtn.addEventListener("click", (e) => {
      e.preventDefault();
      calculateAll();
    });
  }

  const presetSelect = document.getElementById("modelPreset");
  if (presetSelect) {
    presetSelect.addEventListener("change", (e) => {
      const key = e.target.value;
      if (!key) return;
      applyModelPreset(key);
    });
  }

  const copyBtn = document.getElementById("copySummaryButton");
  if (copyBtn) {
    copyBtn.addEventListener("click", (e) => {
      e.preventDefault();
      copySummaryToClipboard();
    });
  }
});


  
